import{l as i,m as d,o,p as P,q as h,r as c,s as R,t as N,u as y}from"./chunk-66qyczwb.js";import{v as _,w as I}from"./chunk-kgqa29h3.js";import{Tb as ZJ}from"./chunk-1pwb5qtb.js";import{$c as D,bd as t}from"./chunk-a17sebxb.js";import{Te as XJ}from"./chunk-trjbmn7w.js";t();var q=function(J,Z,Q,X){function G($){return $ instanceof Q?$:new Q(function(H){H($)})}return new(Q||(Q=Promise))(function($,H){function Y(F){try{K(X.next(F))}catch(V){H(V)}}function C(F){try{K(X.throw(F))}catch(V){H(V)}}function K(F){F.done?$(F.value):G(F.value).then(Y,C)}K((X=X.apply(J,Z||[])).next())})};var r="transport";class w{constructor({context:J,logType:Z}={}){this.exchangeTimeout=30000,this.unresponsiveTimeout=15000,this.deviceModel=null,this._events=new D,this.send=(Q,X,G,$,...H)=>q(this,[Q,X,G,$,...H],void 0,function*(Y,C,K,F,V=Buffer.alloc(0),s=[N.OK],{abortTimeoutMs:f}={}){let A=this.tracer.withUpdatedContext({function:"send"});if(V.length>=256)throw A.trace("data.length exceeded 256 bytes limit",{dataLength:V.length}),new R("data.length exceed 256 bytes limit. Got: "+V.length,"DataLengthTooBig");A.trace("Starting an exchange",{abortTimeoutMs:f});let B=yield this.exchange(Buffer.concat([Buffer.from([Y,C,K,F]),Buffer.from([V.length]),V]),{abortTimeoutMs:f});A.trace("Received response from exchange");let M=B.readUInt16BE(B.length-2);if(!s.some((a)=>a===M))throw new y(M);return B}),this._appAPIlock=null,this.tracer=new I(Z!==null&&Z!==void 0?Z:r,J)}exchange(J,{abortTimeoutMs:Z}={}){throw new Error("exchange not implemented")}exchangeBulk(J,Z){let Q=!1,X=()=>{Q=!0};return(()=>q(this,void 0,void 0,function*(){if(Q)return;for(let $ of J){let H=yield this.exchange($);if(Q)return;let Y=H.readUInt16BE(H.length-2);if(Y!==N.OK)throw new y(Y);Z.next(H)}}))().then(()=>!Q&&Z.complete(),($)=>!Q&&Z.error($)),{unsubscribe:X}}setScrambleKey(J){}close(){return Promise.resolve()}on(J,Z){this._events.on(J,Z)}off(J,Z){this._events.removeListener(J,Z)}emit(J,...Z){this._events.emit(J,...Z)}setDebugMode(){console.warn("setDebugMode is deprecated. use @ledgerhq/logs instead. No logs are emitted in this anymore.")}setExchangeTimeout(J){this.exchangeTimeout=J}setExchangeUnresponsiveTimeout(J){this.unresponsiveTimeout=J}static create(J=3000,Z){return new Promise((Q,X)=>{let G=!1,$=this.listen({next:(Y)=>{if(G=!0,$)$.unsubscribe();if(H)clearTimeout(H);this.open(Y.descriptor,J).then(Q,X)},error:(Y)=>{if(H)clearTimeout(H);X(Y)},complete:()=>{if(H)clearTimeout(H);if(!G)X(new R(this.ErrorMessage_NoDeviceFound,"NoDeviceFound"))}}),H=Z?setTimeout(()=>{$.unsubscribe(),X(new R(this.ErrorMessage_ListenTimeout,"ListenTimeout"))},Z):null})}exchangeAtomicImpl(J){return q(this,void 0,void 0,function*(){let Z=this.tracer.withUpdatedContext({function:"exchangeAtomicImpl",unresponsiveTimeout:this.unresponsiveTimeout});if(this.exchangeBusyPromise)throw Z.trace("Atomic exchange is already busy"),new h("An action was already pending on the Ledger device. Please deny or reconnect.");let Q,X=new Promise((H)=>{Q=H});this.exchangeBusyPromise=X;let G=!1,$=setTimeout(()=>{Z.trace('Timeout reached, emitting Transport event "unresponsive"',{unresponsiveTimeout:this.unresponsiveTimeout}),G=!0,this.emit("unresponsive")},this.unresponsiveTimeout);try{let H=yield J();if(G)Z.trace("Device was unresponsive, emitting responsive"),this.emit("responsive");return H}finally{if(Z.trace("Finalize, clearing busy guard"),clearTimeout($),Q)Q();this.exchangeBusyPromise=null}})}decorateAppAPIMethods(J,Z,Q){for(let X of Z)J[X]=this.decorateAppAPIMethod(X,J[X],J,Q)}decorateAppAPIMethod(J,Z,Q,X){return(...G)=>q(this,void 0,void 0,function*(){let{_appAPIlock:$}=this;if($)return Promise.reject(new R("Ledger Device is busy (lock "+$+")","TransportLocked"));try{return this._appAPIlock=J,this.setScrambleKey(X),yield Z.apply(Q,G)}finally{this._appAPIlock=null}})}setTraceContext(J){this.tracer=this.tracer.withContext(J)}updateTraceContext(J){this.tracer.updateContext(J)}getTraceContext(){return this.tracer.getContext()}}w.ErrorMessage_ListenTimeout="No Ledger device found (timeout)";w.ErrorMessage_NoDeviceFound="No Ledger device found";var T=w;var m=5;function e(J){let Z=Buffer.alloc(2);return Z.writeUInt16BE(J,0),Z}var JJ={data:Buffer.alloc(0),dataLength:0,sequence:0},QJ=(J,Z)=>{return{makeBlocks(Q){let X=Buffer.concat([e(Q.length),Q]),G=Z-5,$=Math.ceil(X.length/G);X=Buffer.concat([X,Buffer.alloc($*G-X.length+1).fill(0)]);let H=[];for(let Y=0;Y<$;Y++){let C=Buffer.alloc(5);C.writeUInt16BE(J,0),C.writeUInt8(m,2),C.writeUInt16BE(Y,3);let K=X.slice(Y*G,(Y+1)*G);H.push(Buffer.concat([C,K]))}return H},reduceResponse(Q,X){let{data:G,dataLength:$,sequence:H}=Q||JJ;if(X.readUInt16BE(0)!==J)throw new R("Invalid channel","InvalidChannel");if(X.readUInt8(2)!==m)throw new R("Invalid tag","InvalidTag");if(X.readUInt16BE(3)!==H)throw new R("Invalid sequence","InvalidSequence");if(!Q)$=X.readUInt16BE(5);H++;let Y=X.slice(Q?5:7);if(G=Buffer.concat([G,Y]),G.length>$)G=G.slice(0,$);return{data:G,dataLength:$,sequence:H}},getReducedResult(Q){if(Q&&Q.dataLength===Q.data.length)return Q.data}}},b=QJ;var E=XJ(ZJ(),1);var O;(function(J){J.blue="blue",J.nanoS="nanoS",J.nanoSP="nanoSP",J.nanoX="nanoX",J.stax="stax",J.europa="europa"})(O||(O={}));var U={[O.blue]:{id:O.blue,productName:"Ledger Blue",productIdMM:0,legacyUsbProductId:0,usbOnly:!0,memorySize:491520,masks:[822083584,822149120],getBlockSize:(J)=>4096},[O.nanoS]:{id:O.nanoS,productName:"Ledger Nano S",productIdMM:16,legacyUsbProductId:1,usbOnly:!0,memorySize:327680,masks:[823132160],getBlockSize:(J)=>{var Z;return E.default.lt((Z=E.default.coerce(J))!==null&&Z!==void 0?Z:"","2.0.0")?4096:2048}},[O.nanoX]:{id:O.nanoX,productName:"Ledger Nano X",productIdMM:64,legacyUsbProductId:4,usbOnly:!1,memorySize:2097152,masks:[855638016],getBlockSize:(J)=>4096,bluetoothSpec:[{serviceUuid:"13d63400-2c97-0004-0000-4c6564676572",notifyUuid:"13d63400-2c97-0004-0001-4c6564676572",writeUuid:"13d63400-2c97-0004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-0004-0003-4c6564676572"}]},[O.nanoSP]:{id:O.nanoSP,productName:"Ledger Nano S Plus",productIdMM:80,legacyUsbProductId:5,usbOnly:!0,memorySize:1569792,masks:[856686592],getBlockSize:(J)=>32},[O.stax]:{id:O.stax,productName:"Ledger Stax",productIdMM:96,legacyUsbProductId:6,usbOnly:!1,memorySize:1569792,masks:[857735168],getBlockSize:(J)=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-6004-0000-4c6564676572",notifyUuid:"13d63400-2c97-6004-0001-4c6564676572",writeUuid:"13d63400-2c97-6004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-6004-0003-4c6564676572"}]},[O.europa]:{id:O.europa,productName:"Ledger Flex",productIdMM:112,legacyUsbProductId:7,usbOnly:!1,memorySize:1569792,masks:[858783744],getBlockSize:(J)=>32,bluetoothSpec:[{serviceUuid:"13d63400-2c97-3004-0000-4c6564676572",notifyUuid:"13d63400-2c97-3004-0001-4c6564676572",writeUuid:"13d63400-2c97-3004-0002-4c6564676572",writeCmdUuid:"13d63400-2c97-3004-0003-4c6564676572"}]}},WJ={Blue:O.blue,"Nano S":O.nanoS,"Nano S Plus":O.nanoSP,"Nano X":O.nanoX,Stax:O.stax,Europa:O.europa},g=Object.values(U),L=11415;var j=(J)=>{let Z=g.find((G)=>G.legacyUsbProductId===J);if(Z)return Z;let Q=J>>8;return g.find((G)=>G.productIdMM===Q)};var $J=[],p={};for(let J in U){let Z=U[J],{bluetoothSpec:Q}=Z;if(Q)for(let X=0;X<Q.length;X++){let G=Q[X];$J.push(G.serviceUuid),p[G.serviceUuid]=p[G.serviceUuid.replace(/-/g,"")]=Object.assign({deviceModel:Z},G)}}var S=function(J,Z,Q,X){function G($){return $ instanceof Q?$:new Q(function(H){H($)})}return new(Q||(Q=Promise))(function($,H){function Y(F){try{K(X.next(F))}catch(V){H(V)}}function C(F){try{K(X.throw(F))}catch(V){H(V)}}function K(F){F.done?$(F.value):G(F.value).then(Y,C)}K((X=X.apply(J,Z||[])).next())})},GJ=[{vendorId:L}];function k(){return S(this,void 0,void 0,function*(){return yield navigator.usb.requestDevice({filters:GJ})})}function x(){return S(this,void 0,void 0,function*(){return(yield navigator.usb.getDevices()).filter((Z)=>Z.vendorId===L)})}function v(){return S(this,void 0,void 0,function*(){let J=yield x();if(J.length>0)return J[0];return k()})}var l=()=>Promise.resolve(!!navigator&&!!navigator.usb&&typeof navigator.usb.getDevices==="function");var z=function(J,Z,Q,X){function G($){return $ instanceof Q?$:new Q(function(H){H($)})}return new(Q||(Q=Promise))(function($,H){function Y(F){try{K(X.next(F))}catch(V){H(V)}}function C(F){try{K(X.throw(F))}catch(V){H(V)}}function K(F){F.done?$(F.value):G(F.value).then(Y,C)}K((X=X.apply(J,Z||[])).next())})},HJ=1,n=3;class W extends T{constructor(J,Z){super();this.channel=Math.floor(Math.random()*65535),this.packetSize=64,this._disconnectEmitted=!1,this._emitDisconnect=(Q)=>{if(this._disconnectEmitted)return;this._disconnectEmitted=!0,this.emit("disconnect",Q)},this.device=J,this.interfaceNumber=Z,this.deviceModel=j(J.productId)}static request(){return z(this,void 0,void 0,function*(){let J=yield k();return W.open(J)})}static openConnected(){return z(this,void 0,void 0,function*(){let J=yield x();if(J.length===0)return null;return W.open(J[0])})}static open(J){return z(this,void 0,void 0,function*(){if(yield J.open(),J.configuration===null)yield J.selectConfiguration(HJ);yield u(J);let Z=J.configurations[0].interfaces.find(({alternates:$})=>$.some((H)=>H.interfaceClass===255));if(!Z)throw new P("No WebUSB interface found for your Ledger device. Please upgrade firmware or contact techsupport.");let Q=Z.interfaceNumber;try{yield J.claimInterface(Q)}catch($){throw yield J.close(),new P($.message)}let X=new W(J,Q),G=($)=>{if(J===$.device)navigator.usb.removeEventListener("disconnect",G),X._emitDisconnect(new i)};return navigator.usb.addEventListener("disconnect",G),X})}close(){return z(this,void 0,void 0,function*(){yield this.exchangeBusyPromise,yield this.device.releaseInterface(this.interfaceNumber),yield u(this.device),yield this.device.close()})}exchange(J){return z(this,void 0,void 0,function*(){return yield this.exchangeAtomicImpl(()=>z(this,void 0,void 0,function*(){let{channel:Q,packetSize:X}=this;_("apdu","=> "+J.toString("hex"));let G=b(Q,X),$=G.makeBlocks(J);for(let C=0;C<$.length;C++)yield this.device.transferOut(n,$[C]);let H,Y;while(!(H=G.getReducedResult(Y))){let C=yield this.device.transferIn(n,X),K=Buffer.from(C.data.buffer);Y=G.reduceResponse(Y,K)}return _("apdu","<= "+H.toString("hex")),H})).catch((Q)=>{if(Q&&Q.message&&Q.message.includes("disconnected"))throw this._emitDisconnect(Q),new d(Q.message);throw Q})})}setScrambleKey(){}}W.isSupported=l;W.list=x;W.listen=(J)=>{let Z=!1;v().then((X)=>{if(!Z){let G=j(X.productId);J.next({type:"add",descriptor:X,deviceModel:G}),J.complete()}},(X)=>{if(window.DOMException&&X instanceof window.DOMException&&X.code===18)J.error(new c(X.message));else J.error(new o(X.message))});function Q(){Z=!0}return{unsubscribe:Q}};var LJ=W;function u(J){return z(this,void 0,void 0,function*(){try{yield J.reset()}catch(Z){console.warn(Z)}})}export{LJ as default};

//# debugId=68CE1D5C1CDA650E64756E2164756E21
